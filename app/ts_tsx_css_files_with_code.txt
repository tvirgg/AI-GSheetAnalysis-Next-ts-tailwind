File: globals.css
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {

}

@media (prefers-color-scheme: dark) {
  :root {

  }
}
html{
  scrollbar-gutter: stable;
}
body {
  background: #F9FAFB;
}

@layer utilities {
  /* .text-balance {
    text-wrap: balance;
  } */
}


File: layout.tsx
import type { Metadata } from 'next'
import { Inter } from 'next/font/google'
import './globals.css'
import { AuthProvider } from './context/AuthContext'

const inter = Inter({ subsets: ['latin'] })

export const metadata: Metadata = {
  title: 'Create Next App',
  description: 'Generated by create next app',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body className={inter.className}>
        {/* AuthProvider wraps the entire application */}
        <AuthProvider>{children}</AuthProvider>
      </body>
    </html>
  )
}


File: page.tsx
export default function HomePage () {
  return (
    <>
      <div>
        Home page
      </div>
    </>
  )
}


File: config.ts
export const API_BASE_URL = 'http://45.66.10.64:4555';

File: AuthContext.tsx
// app/context/AuthContext.tsx
'use client'

import { createContext, useContext, useState, useEffect, ReactNode } from 'react'
import { useRouter } from 'next/navigation'
import { API_BASE_URL } from 'baseapi/config' // Используем новый алиас

interface User {
  id: number
  email: string
  username: string
  auth_type: string
  // Добавьте другие поля по необходимости
}

interface AuthContextType {
  token: string | null
  user: User | null
  loading: boolean
  login: (token: string) => Promise<void>
  logout: () => void
}

const AuthContext = createContext<AuthContextType | undefined>(undefined)

export const AuthProvider = ({ children }: { children: ReactNode }) => {
  const [token, setToken] = useState<string | null>(null)
  const [user, setUser] = useState<User | null>(null)
  const [loading, setLoading] = useState<boolean>(true)
  const router = useRouter()

  useEffect(() => {
    const storedToken = localStorage.getItem('token')
    if (storedToken) {
      setToken(storedToken)
      fetchUserData(storedToken)
    } else {
      setLoading(false)
    }
  }, [])

  const fetchUserData = async (token: string) => {
    try {
      const response = await fetch(`${API_BASE_URL}/user`, {
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      })
      if (!response.ok) {
        throw new Error('Failed to fetch user data')
      }
      const data = await response.json()
      setUser(data.user_data)
      localStorage.setItem('user', JSON.stringify(data.user_data))
    } catch (error) {
      console.error('Ошибка при получении данных пользователя:', error)
      logoutUser()
    } finally {
      setLoading(false)
    }
  }

  const loginUser = async (newToken: string) => {
    localStorage.setItem('token', newToken)
    setToken(newToken)
    setLoading(true)
    await fetchUserData(newToken)
    router.push('/dashboard/my') // Перенаправление после успешного входа
  }

  const logoutUser = () => {
    localStorage.clear()
    setToken(null)
    setUser(null)
    router.push('/signin') // Перенаправление на страницу входа после выхода
  }

  return (
    <AuthContext.Provider value={{ token, user, loading, login: loginUser, logout: logoutUser }}>
      {loading ? (
        // Прелоадер во время загрузки данных
        <div className="flex items-center justify-center h-screen">
          <div className="loader"></div>
        </div>
      ) : (
        children
      )}
    </AuthContext.Provider>
  )
}

export const useAuth = () => {
  const context = useContext(AuthContext)
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider')
  }
  return context
}


File: page.tsx
// app/dashboard/page.tsx
'use client'

import ProtectedRoute from '../../components/ProtectedRoute' // Adjust the import path

export default function Dashboard() {
  return (
    <ProtectedRoute>
      <div>
        <h1>Добро пожаловать в дашборд!</h1>
        {/* Ваш контент */}
      </div>
    </ProtectedRoute>
  )
}


File: page.tsx
'use client'

import { useState, useEffect, useRef } from 'react'
import Sidebar from '@/components/Sidebar'
import Navbar from '@/components/Navbar'
import { API_BASE_URL } from 'baseapi/config' // Убедитесь, что путь корректен

// Определение интерфейсов
interface ChartResponse {
  status: string
  graph_html: string
  timestamp: number
  prompt: string
}

interface TableItem {
  display_name: string
  last_updated: number
  table_name: string
  table_type: string
}

export default function ReportsPage() {
  const [sidebarOpen, setSidebarOpen] = useState(false)
  const [prompt, setPrompt] = useState('')
  const [tableName, setTableName] = useState<string>('')
  const [loading, setLoading] = useState(false)
  const [graphs, setGraphs] = useState<ChartResponse[]>([])
  const [error, setError] = useState<string | null>(null)

  // Состояния для таблиц
  const [tables, setTables] = useState<TableItem[]>([])
  const [tablesLoading, setTablesLoading] = useState<boolean>(false)
  const [tablesError, setTablesError] = useState<string | null>(null)

  // Ссылка для прокрутки к последнему графику
  const lastGraphRef = useRef<HTMLDivElement>(null)

  // Получение таблиц при загрузке компонента
  useEffect(() => {
    const fetchTables = async () => {
      setTablesLoading(true)
      setTablesError(null)

      try {
        const token = localStorage.getItem('token') // Получаем токен из localStorage

        const response = await fetch(`${API_BASE_URL}/tables`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`, // Добавляем токен в заголовок
          },
        })

        if (!response.ok) {
          const errorText = await response.text()
          throw new Error(
            `Ошибка при получении таблиц: ${response.status} ${response.statusText}. ${errorText}`
          )
        }

        const data: { tables: TableItem[] } = await response.json()
        setTables(data.tables)
      } catch (err: any) {
        setTablesError(
          err.message || 'Произошла ошибка при получении таблиц.'
        )
      } finally {
        setTablesLoading(false)
      }
    }

    fetchTables()
  }, [])

  // Прокрутка к последнему графику при добавлении нового графика
  useEffect(() => {
    if (lastGraphRef.current) {
      lastGraphRef.current.scrollIntoView({ behavior: 'smooth' })
    }
  }, [graphs])

  // Функция для обработки отправки запроса
  const handleSubmit = async () => {
    // Проверка, что запрос не пустой
    if (!prompt.trim()) {
      setError('Пожалуйста, введите запрос.')
      return
    }

    // Проверка, что выбран источник
    if (!tableName) {
      setError('Пожалуйста, выберите источник данных.')
      return
    }

    setLoading(true)
    setError(null)

    try {
      const token = localStorage.getItem('token') // Получаем токен из localStorage

      const response = await fetch(`${API_BASE_URL}/create_chart`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`, // Добавляем токен в заголовок
        },
        body: JSON.stringify({
          table_name: tableName,
          chart_prompt: prompt,
        }),
      })

      if (!response.ok) {
        const errorText = await response.text()
        throw new Error(
          `Ошибка: ${response.status} ${response.statusText}. ${errorText}`
        )
      }

      const data: ChartResponse = await response.json()

      if (data.status === 'success') {
        setGraphs((prevGraphs) => [...prevGraphs, data]) // Добавляем новый график в массив
        setPrompt('') // Очищаем поле ввода
      } else {
        throw new Error('Не удалось создать график.')
      }
    } catch (err: any) {
      setError(err.message || 'Произошла ошибка.')
    } finally {
      setLoading(false)
    }
  }

  return (
    <>
      <div className="flex h-screen bg-gray-100">
        {/* Sidebar */}
        <Sidebar sidebarOpen={sidebarOpen} setSidebarOpen={setSidebarOpen} />

        {/* Main Content */}
        <div className="flex-1 flex flex-col lg:pl-72">
          <Navbar setSidebarOpen={setSidebarOpen} />

          <main className="flex-1 flex flex-col relative">
            {/* Область ответов (графики) */}
            <div className="flex-1 overflow-y-auto px-4 sm:px-6 lg:px-8 py-6 mb-24 bg-gray-50">
              <div className="max-w-4xl mx-auto">
                {graphs.length === 0 ? (
                  <div className="flex flex-col h-full justify-center items-center space-y-6">
                    {/* Header Section */}
                    <div className="text-center">
                      <h1 className="font-semibold text-2xl">Аишка</h1>
                      <p className="mt-4">
                        Задавайте вопросы, чтобы получить информацию
                        <br />
                        о состоянии бизнеса и наиболее важных показателях
                      </p>
                    </div>
                    {/* Suggested Questions */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full">
                      <div
                        className="p-10 border rounded-lg shadow hover:bg-gray-100 cursor-pointer"
                        onClick={() =>
                          setPrompt(
                            'Какие показатели ухудшились в этом месяце?'
                          )
                        }
                      >
                        Какие показатели ухудшились в этом месяце?
                      </div>
                      <div
                        className="p-10 border rounded-lg shadow hover:bg-gray-100 cursor-pointer"
                        onClick={() =>
                          setPrompt('Есть ли риск кассового разрыва?')
                        }
                      >
                        Есть ли риск кассового разрыва?
                      </div>
                      <div
                        className="p-10 border rounded-lg shadow hover:bg-gray-100 cursor-pointer"
                        onClick={() =>
                          setPrompt(
                            'Какие мои товары имеют наибольшую маржу?'
                          )
                        }
                      >
                        Какие мои товары имеют наибольшую маржу?
                      </div>
                      <div
                        className="p-10 border rounded-lg shadow hover:bg-gray-100 cursor-pointer"
                        onClick={() =>
                          setPrompt(
                            'Кто из продавцов не выполнил план в последнем месяце?'
                          )
                        }
                      >
                        Кто из продавцов не выполнил план в последнем месяце?
                      </div>
                    </div>
                  </div>
                ) : (
                  <div className="flex flex-col space-y-6">
                    {graphs.map((graph, index) => (
                      <div
                        key={index}
                        ref={index === graphs.length - 1 ? lastGraphRef : null}
                      >
                        <div className="bg-gray-50 p-4 rounded-lg shadow">
                          <p className="text-sm text-gray-600 mb-2 ml-1">
                            <strong>Запрос:</strong> {graph.prompt}
                          </p>
                          <iframe
                            srcDoc={atob(graph.graph_html)}
                            style={{
                              width: '100%',
                              height: '500px',
                              border: 'none',
                              overflow: 'hidden',
                            }}
                            title={`Graph-${index}`}
                            sandbox="allow-scripts allow-same-origin"
                          />
                          <p className="text-xs text-gray-500 mt-2">
                            Создано:{' '}
                            {new Date(
                              graph.timestamp * 1000
                            ).toLocaleString()}
                          </p>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>

            {/* Фиксированный блок ввода запроса и дисклэймер */}
            <div className="fixed bottom-0 left-0 right-0 lg:left-72 z-50">
              {/* Внешний контейнер фиксированного блока ввода с серым фоном */}
              <div className="bg-gray-50">
                {/* Внутренний контейнер с отступами и ограниченной шириной */}
                <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4 border-t border-gray-200 shadow-custom bg-white">
                  <div className="flex flex-col space-y-4">
                    {/* Input Prompt */}
                    <div className="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 w-full">
                      <input
                        type="text"
                        placeholder="Введите запрос"
                        value={prompt}
                        onChange={(e) => setPrompt(e.target.value)}
                        className="flex-1 border p-2 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      <button
                        onClick={handleSubmit}
                        className="bg-blue-500 text-white px-4 py-2 rounded-lg disabled:bg-blue-300"
                        disabled={loading || tablesLoading}
                      >
                        {loading ? 'Загрузка...' : 'Узнать'}
                      </button>
                    </div>

                    {/* Селект источника */}
                    <div className="flex items-center space-x-2 w-full">
                      <label htmlFor="source" className="font-semibold">
                        Источник:
                      </label>
                      <div className="flex-1">
                        {tablesLoading ? (
                          <p>Загрузка источников...</p>
                        ) : tablesError ? (
                          <p className="text-red-500">{tablesError}</p>
                        ) : tables.length === 0 ? (
                          <p>Таблицы не найдены.</p>
                        ) : (
                          <select
                            id="source"
                            value={tableName}
                            onChange={(e) => setTableName(e.target.value)}
                            className="w-full border p-2 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                          >
                            <option value="">Выберите источник</option>
                            {tables.map((table) => (
                              <option
                                key={table.table_name}
                                value={table.table_name}
                              >
                                {table.display_name}
                              </option>
                            ))}
                          </select>
                        )}
                      </div>
                    </div>

                    {/* Отображение ошибок */}
                    {error && (
                      <div className="p-4 bg-red-100 text-red-700 rounded-lg w-full">
                        {error}
                      </div>
                    )}
                  </div>

                  {/* Disclaimer */}
                </div>
                <div className="text-center text-sm text-gray-500 p-3">
                  Аишка может допускать ошибки. Рекомендуем проверять важную информацию.
                </div>
              </div>
            </div>
          </main>
        </div>
      </div>

      {/* Стили для кастомного скроллбара и боковой тени */}
      <style jsx>{`
        /* Стилизация кастомного скроллбара для области ответов */
        .overflow-y-auto::-webkit-scrollbar {
          width: 8px;
        }

        .overflow-y-auto::-webkit-scrollbar-track {
          background: #f1f1f1;
          border-radius: 4px;
        }

        .overflow-y-auto::-webkit-scrollbar-thumb {
          background-color: #c1c1c1;
          border-radius: 4px;
        }

        /* Для Firefox */
        .overflow-y-auto {
          scrollbar-width: thin;
          scrollbar-color: #c1c1c1 #f1f1f1;
        }

        /* Кастомная тень для блока ввода */
        .shadow-custom {
          border-radius: 10px;
        }

        .loader {
          border-top-color: #3498db;
          animation: spin 1s infinite linear;
        }

        @keyframes spin {
          to {
            transform: rotate(360deg);
          }
        }
      `}</style>
    </>
  )
}


File: page.tsx
// app/dashboard/my/page.tsx
'use client'

import { useState, useEffect, Fragment } from 'react'
import { Dialog, Transition } from '@headlessui/react'
import { PlusIcon, TrashIcon, CircleStackIcon } from '@heroicons/react/24/outline'
import Sidebar from '@/components/Sidebar'
import Navbar from '@/components/Navbar'
import axios from 'axios'
import { API_BASE_URL } from 'baseapi/config'
import { useAuth } from '@/app/context/AuthContext'

// Функция для объединения классов
function classNames(...classes: Array<string>) {
  return classes.filter(Boolean).join(' ')
}

// Интерфейсы для типов данных
interface Graph {
  id: number
  timestamp: number
  prompt: string
  graph_html: string // base64
  is_up_to_date: boolean
}

interface DashboardData {
  display_name: string
  data: Array<Record<string, any>>
  columns: Array<string>
  descriptions: Record<string, string>
  graphs: Array<Graph>
}

export default function MyDashboard() {
  const { token } = useAuth()
  const [sidebarOpen, setSidebarOpen] = useState(false)
  const [isAddMetricOpen, setIsAddMetricOpen] = useState(false)
  const [currentSection, setCurrentSection] = useState<string>('')
  const [metricName, setMetricName] = useState('')
  const [dashboardData, setDashboardData] = useState<DashboardData[]>([])
  const [isLoading, setIsLoading] = useState<boolean>(false)
  const [notification, setNotification] = useState<{ type: string; message: string } | null>(null)

  // Получение данных дэшборда при монтировании компонента
  useEffect(() => {
    // Загружаем данные из localStorage при монтировании компонента
    const storedData = localStorage.getItem('dashboardData')
    if (storedData) {
      setDashboardData(JSON.parse(storedData))
    } else {
      setIsLoading(true)
    }

    if (token) {
      fetchDashboardData()
    }
  }, [token])

  // Функция для получения заголовков авторизации
  const getAuthHeaders = () => {
    return {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`,
    }
  }

  const fetchDashboardData = async () => {
    setIsLoading(true)
    try {
      const response = await axios.get(`${API_BASE_URL}/all_dashboards`, {
        headers: getAuthHeaders(),
      })
      const data: DashboardData[] = response.data.tables || response.data
      setDashboardData(data)
      // Сохраняем данные в localStorage
      localStorage.setItem('dashboardData', JSON.stringify(data))
    } catch (err: any) {
      console.error(err)
      setNotification({ type: 'error', message: 'Ошибка при загрузке данных дэшборда.' })
    } finally {
      setIsLoading(false)
    }
  }

  // Обработчик открытия модального окна для добавления показателя
  const openAddMetricModal = (section: string) => {
    setCurrentSection(section)
    setIsAddMetricOpen(true)
  }

  // Обработчик закрытия модального окна
  const closeAddMetricModal = () => {
    setIsAddMetricOpen(false)
    setMetricName('')
    setCurrentSection('')
  }

  // Обработчик добавления показателя
  const handleAddMetric = async () => {
    try {
      const payload = {
        table_name: currentSection,
        chart_prompt: metricName,
      }

      // Отправьте соответствующий запрос на сервер для добавления графика
      const response = await axios.post(`${API_BASE_URL}/create_chart`, payload, {
        headers: getAuthHeaders(),
      })

      if (response.status === 200 && response.data.status === 'success') {
        setNotification({ type: 'success', message: 'График успешно добавлен.' })
        await fetchDashboardData()
        closeAddMetricModal()
      } else {
        throw new Error(response.data.message || 'Не удалось добавить график.')
      }
    } catch (err: any) {
      console.error(err)
      setNotification({ type: 'error', message: err.response?.data?.message || 'Ошибка при добавлении графика.' })
    }
  }

  // Обработчик удаления графика
  const handleDeleteGraph = async (graphId: number, displayName: string) => {
    const confirmed = confirm('Вы действительно хотите удалить этот график?')
    if (!confirmed) return

    try {
      const response = await axios.post(`${API_BASE_URL}/delete_graph`, {
        graph_id: graphId,
        table_name: displayName,
      }, {
        headers: getAuthHeaders(),
      })

      if (response.status === 200 && response.data.status === 'success') {
        setNotification({ type: 'success', message: response.data.message })
        await fetchDashboardData()
      } else {
        throw new Error(response.data.message || 'Не удалось удалить график.')
      }
    } catch (err: any) {
      console.error(err)
      setNotification({ type: 'error', message: err.response?.data?.message || 'Что-то пошло не так.' })
    }
  }

  // Обработчик обновления графика
  const handleRefreshGraph = async (graphId: number, displayName: string) => {
    try {
      const response = await axios.post(`${API_BASE_URL}/refresh_graph`, {
        graph_id: graphId,
        table_name: displayName,
      }, {
        headers: getAuthHeaders(),
      })

      if (response.status === 200 && response.data.status === 'success') {
        setNotification({ type: 'success', message: response.data.message })
        await fetchDashboardData()
      } else {
        throw new Error(response.data.message || 'Не удалось обновить график.')
      }
    } catch (err: any) {
      console.error(err)
      setNotification({ type: 'error', message: err.response?.data?.message || 'Что-то пошло не так.' })
    }
  }

  // Автоматически скрывать уведомление через 5 секунд
  useEffect(() => {
    if (notification) {
      const timer = setTimeout(() => {
        setNotification(null)
      }, 5000)

      return () => clearTimeout(timer)
    }
  }, [notification])

  return (
    <div>
      {/* Sidebar */}
      <Sidebar sidebarOpen={sidebarOpen} setSidebarOpen={setSidebarOpen} />

      <div className="lg:pl-72">
        {/* Navbar */}
        <Navbar setSidebarOpen={setSidebarOpen} />

        {/* Основной контент страницы */}
        <main className="py-10">
          <div className="px-4 sm:px-6 lg:px-8">
            {/* Уведомления */}
            {notification && (
              <div className="mt-4">
                <div
                  className={`rounded-md p-4 ${
                    notification.type === 'success' ? 'bg-green-100' : 'bg-red-100'
                  }`}
                >
                  <div className="flex">
                    <div className="ml-3">
                      <p
                        className={`text-sm font-medium ${
                          notification.type === 'success' ? 'text-green-800' : 'text-red-800'
                        }`}
                      >
                        {notification.message}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Обработка состояния загрузки */}
            {isLoading && (
              <div className="flex justify-center items-center h-64">
                <p className="text-gray-500">Загрузка данных...</p>
              </div>
            )}

            {/* Отображение данных дэшборда */}
            {!isLoading && dashboardData && dashboardData.length > 0 ? (
              dashboardData.map((section) => (
                <section key={section.display_name} className="mt-12">
                  <div className="mt-2 md:flex md:items-center md:justify-between">
                    <div className="min-w-0 flex-1">
                      <h2 className="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">
                        {section.display_name}
                      </h2>
                    </div>
                    <div className="mt-4 flex flex-shrink-0 md:ml-4 md:mt-0">
                      <button
                        type="button"
                        onClick={() => openAddMetricModal(section.display_name)}
                        className="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
                      >
                        <PlusIcon aria-hidden="true" className="h-5 w-5" />
                      </button>
                    </div>
                  </div>

                  {/* Отображение графиков */}
                  <div className="mt-4 grid grid-cols-1 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {section.graphs && section.graphs.length > 0 ? (
                      section.graphs.map((graph) => (
                        <div key={graph.id} className="relative bg-white p-4 rounded-lg shadow flex flex-col">
                          {/* Кнопка удаления графика */}
                          <button
                            onClick={() => handleDeleteGraph(graph.id, section.display_name)}
                            className="absolute top-2 right-2 text-red-500 hover:text-red-700"
                            aria-label="Удалить график"
                          >
                            <TrashIcon className="h-5 w-5" />
                          </button>

                          {/* Кнопка обновления графика */}
                          <button
                            onClick={() => handleRefreshGraph(graph.id, section.display_name)}
                            className="absolute top-2 left-2 text-indigo-500 hover:text-indigo-700"
                            aria-label="Обновить график"
                          >
                            <CircleStackIcon className="h-5 w-5" />
                          </button>

                          {/* Отображение графика через iframe */}
                          <div className="flex-1">
                            <iframe
                              srcDoc={atob(graph.graph_html)}
                              style={{
                                width: '100%',
                                height: '500px', // Установленная фиксированная высота
                                border: 'none',
                                overflow: 'hidden',
                              }}
                              title={graph.prompt}
                              sandbox="allow-scripts allow-same-origin"
                            />
                          </div>

                          <p className="mt-2 text-sm text-gray-500">{graph.prompt}</p>
                        </div>
                      ))
                    ) : (
                      <div className="col-span-full text-center p-4 text-gray-500">
                        Показатели отсутствуют. Нажмите на кнопку{' '}
                        <PlusIcon aria-hidden="true" className="inline h-5 w-5" /> справа, чтобы добавить.
                      </div>
                    )}
                  </div>
                </section>
              ))
            ) : (
              !isLoading && (
                <div className="text-center p-4 text-gray-500">
                  Нет доступных данных.
                </div>
              )
            )}

            {/* Модальное окно для добавления показателя */}
            <Transition.Root show={isAddMetricOpen} as={Fragment}>
              <Dialog as="div" className="relative z-10" onClose={closeAddMetricModal}>
                {/* Затемняющий фон */}
                <Transition.Child
                  as={Fragment}
                  enter="ease-out duration-300"
                  enterFrom="opacity-0"
                  enterTo="opacity-100"
                  leave="ease-in duration-200"
                  leaveFrom="opacity-100"
                  leaveTo="opacity-0"
                >
                  <div className="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" />
                </Transition.Child>

                {/* Контейнер модального окна */}
                <div className="fixed inset-0 z-10 overflow-y-auto">
                  <div className="flex min-h-full items-center justify-center p-4 text-center">
                    <Transition.Child
                      as={Fragment}
                      enter="ease-out duration-300"
                      enterFrom="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                      enterTo="opacity-100 translate-y-0 sm:scale-100"
                      leave="ease-in duration-200"
                      leaveFrom="opacity-100 translate-y-0 sm:scale-100"
                      leaveTo="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                    >
                      <Dialog.Panel className="relative transform overflow-hidden rounded-lg bg-white px-4 pt-5 pb-4 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6">
                        {/* Заголовок модального окна */}
                        <Dialog.Title
                          as="h3"
                          className="text-lg leading-6 font-medium text-gray-900 text-center"
                        >
                          Какой показатель вы хотите добавить?
                        </Dialog.Title>
                        <div className="mt-5">
                          {/* Поле ввода названия показателя */}
                          <div className="mb-4">
                            <label htmlFor="metricName" className="block text-sm font-medium text-gray-700">
                              Название показателя
                            </label>
                            <input
                              id="metricName"
                              type="text"
                              required
                              placeholder="Например, выручка, прибыль, проданные товары"
                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                              value={metricName}
                              onChange={(e) => setMetricName(e.target.value)}
                            />
                          </div>

                          {/* Кнопка добавления показателя */}
                          <div className="mt-5 sm:mt-6">
                            <button
                              type="button"
                              disabled={!metricName}
                              className={classNames(
                                metricName
                                  ? 'bg-indigo-600 hover:bg-indigo-700'
                                  : 'bg-indigo-300 cursor-not-allowed',
                                'w-full inline-flex justify-center rounded-md border border-transparent px-4 py-2 text-base font-medium text-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 sm:text-sm'
                              )}
                              onClick={handleAddMetric}
                            >
                              Добавить показатель
                            </button>
                          </div>
                        </div>
                      </Dialog.Panel>
                    </Transition.Child>
                  </div>
                </div>
              </Dialog>
            </Transition.Root>
            {/* Конец модального окна */}
          </div>
        </main>
      </div>
    </div>
  )
}


File: page.tsx
// app/dashboard/profile_settings/page.tsx
'use client'

import { useState, useEffect } from 'react'
import { UserIcon, PencilIcon, CheckIcon } from '@heroicons/react/24/outline'
import Sidebar from '@/components/Sidebar'
import Navbar from '@/components/Navbar'
import axios from 'axios'
import { API_BASE_URL } from 'baseapi/config' // Используем новый алиас
import { useAuth } from '@/app/context/AuthContext'

interface UserProfile {
  id: number
  email: string
  username: string
  auth_type: string
}

export default function ProfilePage() {
  const { token, user } = useAuth()
  const [profile, setProfile] = useState<UserProfile | null>(null)
  const [isEditing, setIsEditing] = useState(false)
  const [isLoading, setIsLoading] = useState(false)

  useEffect(() => {
    if (user) {
      setProfile(user)
    }
  }, [user])

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (!profile) return
    const { name, value } = e.target
    setProfile({ ...profile, [name]: value })
  }

  const handleSaveChanges = async () => {
    if (!profile) return
    setIsLoading(true)
    try {
      const response = await axios.put(`${API_BASE_URL}/user`, profile, {
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      })
      if (response.status === 200) {
        setIsEditing(false)
        alert('Профиль успешно обновлен!')
      }
    } catch (err) {
      console.error('Ошибка при сохранении профиля:', err)
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <div>
      <Sidebar sidebarOpen={false} setSidebarOpen={() => {}} />
      <div className="lg:pl-72">
        <Navbar setSidebarOpen={() => {}} />
        <main className="py-10">
          <div className="px-4 sm:px-6 lg:px-8">
            <div className="mt-6 max-w-3xl mx-auto bg-white shadow sm:rounded-lg p-6">
              {isLoading ? (
                <p>Загрузка...</p>
              ) : (
                <>
                  {!isEditing ? (
                    <div className="space-y-6">
                      <div className="flex items-center">
                        <UserIcon className="h-6 w-6 text-gray-400" />
                        <span className="ml-3 text-gray-700">{profile?.username}</span>
                      </div>
                      <div className="flex items-center">
                        <UserIcon className="h-6 w-6 text-gray-400" />
                        <span className="ml-3 text-gray-700">{profile?.email}</span>
                      </div>
                      {/* Добавьте другие поля по необходимости */}
                      <button
                        type="button"
                        onClick={() => setIsEditing(true)}
                        className="inline-flex items-center px-4 py-2 bg-blue-500 text-white rounded-md shadow-sm"
                      >
                        <PencilIcon className="h-5 w-5 mr-2" />
                        Изменить
                      </button>
                    </div>
                  ) : (
                    <form className="space-y-6">
                      {/* Имя пользователя */}
                      <div className="flex items-center">
                        <UserIcon className="h-6 w-6 text-gray-400" />
                        <input
                          type="text"
                          name="username"
                          value={profile?.username || ''}
                          onChange={handleInputChange}
                          className="ml-3 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                          placeholder="Имя пользователя"
                        />
                      </div>

                      {/* Email */}
                      <div className="flex items-center">
                        <UserIcon className="h-6 w-6 text-gray-400" />
                        <input
                          type="email"
                          name="email"
                          value={profile?.email || ''}
                          onChange={handleInputChange}
                          className="ml-3 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                          placeholder="Email"
                        />
                      </div>

                      {/* Кнопки */}
                      <div className="flex justify-between">
                        <button
                          type="button"
                          onClick={handleSaveChanges}
                          className="inline-flex items-center px-4 py-2 bg-green-500 text-white rounded-md shadow-sm"
                        >
                          <CheckIcon className="h-5 w-5 mr-2" />
                          Сохранить
                        </button>
                        <button
                          type="button"
                          onClick={() => setIsEditing(false)}
                          className="inline-flex items-center px-4 py-2 bg-gray-500 text-white rounded-md shadow-sm"
                        >
                          Отмена
                        </button>
                      </div>
                    </form>
                  )}
                </>
              )}
            </div>
          </div>
        </main>
      </div>
    </div>
  )
}


File: page.tsx
// app/dashboard/reports/page.tsx
'use client'

import { useState, useEffect, Fragment } from 'react'
import { Dialog, Transition } from '@headlessui/react'
import {
  ArrowDownTrayIcon,
  DocumentIcon,
  PlayCircleIcon,
  XMarkIcon,
} from '@heroicons/react/24/outline'
import Sidebar from '@/components/Sidebar'
import Navbar from '@/components/Navbar'
import axios from 'axios'
import { API_BASE_URL } from 'baseapi/config'
import { useAuth } from '@/app/context/AuthContext'

// Функция для объединения классов
function classNames(...classes: Array<string>) {
  return classes.filter(Boolean).join(' ')
}

// Интерфейсы
interface Tab {
  name: string
  href: string
  current: boolean
}

interface TableMetadata {
  table_name: string
  display_name: string
  table_type: 'excel' | 'google'
  last_updated: string // ISO формат
}

interface ColumnSchema {
  column_name: string
  column_type: string
  column_desc: string
}

// Вкладки
const initialTabs: Array<Tab> = [
  { name: 'Google таблицы', href: '#', current: true },
  { name: 'Excel', href: '#', current: false },
]

export default function ReportsPage() {
  const { token } = useAuth()

  // Состояния
  const [sidebarOpen, setSidebarOpen] = useState(false)
  const [isOpen, setIsOpen] = useState(false)
  const [isEditColumnsOpen, setIsEditColumnsOpen] = useState(false)
  const [uploadedFileName, setUploadedFileName] = useState('')
  const [reportType, setReportType] = useState('Управленческий отчет')
  const [reportName, setReportName] = useState('')
  const [currentTabs, setCurrentTabs] = useState(initialTabs)
  const [googleSheetURL, setGoogleSheetURL] = useState('')
  const [tables, setTables] = useState<TableMetadata[]>([])
  const [loading, setLoading] = useState<boolean>(false)
  const [notification, setNotification] = useState<{ type: string; message: string } | null>(null)
  const [currentEditingTable, setCurrentEditingTable] = useState<TableMetadata | null>(null)
  const [schema, setSchema] = useState<{ name: string; columns: ColumnSchema[] } | null>(null)
  const [newTableData, setNewTableData] = useState<{ sheet_url: string; display_name: string } | null>(null)

  const currentTab = currentTabs.find((tab) => tab.current)?.name

  // Загрузка таблиц при монтировании компонента
  useEffect(() => {
    const storedTables = localStorage.getItem('tables')
    if (storedTables) {
      setTables(JSON.parse(storedTables))
    } else {
      setLoading(true)
    }

    if (token) {
      fetchTables()
    }
  }, [token])

  const getAuthHeaders = () => {
    return {
      'Authorization': `Bearer ${token}`,
    }
  }

  const fetchTables = async () => {
    setLoading(true)
    try {
      const response = await axios.get(`${API_BASE_URL}/tables`, {
        headers: getAuthHeaders(),
      })
      const data = response.data
      if (data.tables && Array.isArray(data.tables)) {
        setTables(data.tables)
        localStorage.setItem('tables', JSON.stringify(data.tables))
      } else {
        setNotification({ type: 'error', message: 'Некорректный формат данных от сервера.' })
      }
    } catch (err: any) {
      console.error(err)
      setNotification({ type: 'error', message: 'Ошибка при загрузке таблиц.' })
    } finally {
      setLoading(false)
    }
  }

  // Добавление отчета
  const handleAddReport = async () => {
    try {
      if (currentTab === 'Google таблицы') {
        const payload = {
          google_sheet_url: googleSheetURL,
          display_name: reportName || 'Новый Google отчет',
          report_type: reportType,
        }

        const response = await axios.post(`${API_BASE_URL}/add_google_table`, payload, {
          headers: getAuthHeaders(),
        })

        if (response.status === 200 && response.data.status === 'success') {
          const newTable: TableMetadata = response.data.table
          setTables([...tables, newTable])
          localStorage.setItem('tables', JSON.stringify([...tables, newTable]))
          setNotification({ type: 'success', message: 'Google таблица успешно добавлена.' })

          // Генерация схемы таблицы
          const schemaResponse = await axios.post(
            `${API_BASE_URL}/generate_schema`,
            {
              sheet_url: googleSheetURL,
              num_rows: null,
            },
            {
              headers: getAuthHeaders(),
            }
          )

          if (schemaResponse.status === 200 && schemaResponse.data) {
            setSchema(schemaResponse.data)
            setNewTableData({
              sheet_url: googleSheetURL,
              display_name: reportName || 'Новый Google отчет',
            })
            setIsOpen(false)
            setIsEditColumnsOpen(true)
            setGoogleSheetURL('')
            setReportName('')
          } else {
            throw new Error('Не удалось сгенерировать схему таблицы.')
          }
        } else {
          throw new Error(response.data.message || 'Не удалось добавить Google таблицу.')
        }
      }
    } catch (err: any) {
      console.error(err)
      setNotification({
        type: 'error',
        message: err.response?.data?.message || 'Ошибка при добавлении отчета.',
      })
    }
  }

  // Создание таблицы после редактирования колонок
  const handleCreateTable = async () => {
    try {
      if (schema && newTableData) {
        const payload = {
          json_data: schema,
          sheet_url: newTableData.sheet_url,
          num_rows: null,
          display_name: newTableData.display_name,
        }

        const response = await axios.post(`${API_BASE_URL}/create_table`, payload, {
          headers: getAuthHeaders(),
        })

        if (response.status === 200 && response.data.status === 'success') {
          setNotification({ type: 'success', message: 'Таблица успешно создана.' })
          setIsEditColumnsOpen(false)
          setSchema(null)
          setNewTableData(null)
          await fetchTables()
        } else {
          throw new Error(response.data.message || 'Не удалось создать таблицу.')
        }
      }
    } catch (err: any) {
      console.error(err)
      setNotification({
        type: 'error',
        message: err.response?.data?.message || 'Ошибка при создании таблицы.',
      })
    }
  }

  // Обновление таблицы
  const handleUpdateTable = async (table_name: string) => {
    try {
      setLoading(true)
      const response = await axios.post(
        `${API_BASE_URL}/update_table`,
        { table_name },
        {
          headers: getAuthHeaders(),
        }
      )

      if (response.status === 200 && response.data.status === 'success') {
        setNotification({ type: 'success', message: 'Таблица успешно обновлена.' })
        await fetchTables()
      } else {
        throw new Error(response.data.message || 'Не удалось обновить таблицу.')
      }
    } catch (err: any) {
      console.error(err)
      setNotification({
        type: 'error',
        message: err.response?.data?.message || 'Ошибка при обновлении таблицы.',
      })
    } finally {
      setLoading(false)
    }
  }

  // Удаление таблицы
  const handleDeleteTable = async (table_name: string) => {
    if (!confirm('Вы уверены, что хотите удалить эту таблицу?')) return

    try {
      setLoading(true)
      const response = await axios.delete(`${API_BASE_URL}/tables/${table_name}`, {
        headers: getAuthHeaders(),
      })

      if (response.status === 200 && response.data.status === 'success') {
        const updatedTables = tables.filter((table) => table.table_name !== table_name)
        setTables(updatedTables)
        localStorage.setItem('tables', JSON.stringify(updatedTables))
        setNotification({ type: 'success', message: 'Таблица успешно удалена.' })
      } else {
        throw new Error(response.data.message || 'Не удалось удалить таблицу.')
      }
    } catch (err: any) {
      console.error(err)
      setNotification({
        type: 'error',
        message: err.response?.data?.message || 'Ошибка при удалении таблицы.',
      })
    } finally {
      setLoading(false)
    }
  }

  // Переключение вкладок
  const handleTabClick = (selectedTabName: string) => {
    const updatedTabs = currentTabs.map((tab) => ({
      ...tab,
      current: tab.name === selectedTabName,
    }))
    setCurrentTabs(updatedTabs)
  }

  // Фильтрация таблиц
  const filteredTables = tables.filter((table) => {
    if (currentTab === 'Excel') return table.table_type === 'excel'
    if (currentTab === 'Google таблицы') return table.table_type === 'google'
    return true
  })

  // Автоматическое скрытие уведомлений
  useEffect(() => {
    if (notification) {
      const timer = setTimeout(() => {
        setNotification(null)
      }, 5000)

      return () => clearTimeout(timer)
    }
  }, [notification])

  return (
    <div>
      {/* Sidebar */}
      <Sidebar sidebarOpen={sidebarOpen} setSidebarOpen={setSidebarOpen} />

      <div className="lg:pl-72">
        {/* Navbar */}
        <Navbar setSidebarOpen={setSidebarOpen} />

        {/* Основной контент страницы */}
        <main className="py-10">
          <div className="px-4 sm:px-6 lg:px-8">
            {/* Заголовок страницы */}
            <div>
              <h2 className="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">
                Загрузить отчеты
              </h2>
            </div>

            {/* Уведомления */}
            {notification && (
              <div className="mt-4">
                <div
                  className={`rounded-md p-4 ${
                    notification.type === 'success' ? 'bg-green-100' : 'bg-red-100'
                  }`}
                >
                  <div className="flex">
                    <div className="ml-3">
                      <p
                        className={`text-sm font-medium ${
                          notification.type === 'success' ? 'text-green-800' : 'text-red-800'
                        }`}
                      >
                        {notification.message}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Вкладки */}
            <div className="mt-10">
              {/* Для мобильных устройств */}
              <div className="sm:hidden">
                <label htmlFor="tabs" className="sr-only">
                  Выберите вкладку
                </label>
                <select
                  id="tabs"
                  name="tabs"
                  value={currentTab}
                  onChange={(e) => handleTabClick(e.target.value)}
                  className="block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm"
                >
                  {currentTabs.map((tab) => (
                    <option key={tab.name} value={tab.name}>
                      {tab.name}
                    </option>
                  ))}
                </select>
              </div>
              {/* Для настольных устройств */}
              <div className="hidden sm:block">
                <div className="border-b border-gray-200">
                  <nav aria-label="Tabs" className="-mb-px flex space-x-8">
                    {currentTabs.map((tab) => (
                      <button
                        key={tab.name}
                        onClick={() => handleTabClick(tab.name)}
                        className={classNames(
                          tab.current
                            ? 'border-indigo-500 text-indigo-600'
                            : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700',
                          'whitespace-nowrap border-b-2 px-1 py-4 text-sm font-medium'
                        )}
                      >
                        {tab.name}
                      </button>
                    ))}
                  </nav>
                </div>
              </div>
            </div>

            {/* Кнопки действий */}
            <div>
              <div className="mt-6 flex gap-4">
                {currentTab === 'Google таблицы' && (
                  <button
                    type="button"
                    onClick={() => setIsOpen(true)}
                    className="inline-flex items-center gap-x-1.5 rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                  >
                    <ArrowDownTrayIcon aria-hidden="true" className="-ml-0.5 h-5 w-5" />
                    Загрузить гугл таблицу
                  </button>
                )}

                {/* Дополнительные кнопки */}
                <button
                  type="button"
                  className="inline-flex items-center gap-x-1.5 rounded-md bg-white px-3 py-2 text-sm text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
                >
                  <DocumentIcon aria-hidden="true" className="-ml-0.5 h-5 w-5" />
                  Пример файла
                </button>

                <button
                  type="button"
                  className="inline-flex items-center gap-x-1.5 rounded-md bg-white px-3 py-2 text-sm text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
                >
                  <PlayCircleIcon aria-hidden="true" className="-ml-0.5 h-5 w-5" />
                  Видео инструкция
                </button>
              </div>
            </div>

            {/* Таблица отчетов */}
            <div className="mt-8 flow-root">
              <div className="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                <div className="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                  <div className="overflow-hidden shadow ring-1 ring-black ring-opacity-5 sm:rounded-lg">
                    <table className="min-w-full divide-y divide-gray-300">
                      <thead className="bg-gray-50">
                        <tr>
                          <th
                            scope="col"
                            className="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6"
                          >
                            Имя
                          </th>
                          <th
                            scope="col"
                            className="px-3 py-3.5 text-left text-sm font-semibold text-gray-900"
                          >
                            Тип отчета
                          </th>
                          <th
                            scope="col"
                            className="px-3 py-3.5 text-left text-sm font-semibold text-gray-900"
                          >
                            Статус
                          </th>
                          <th
                            scope="col"
                            className="px-3 py-3.5 text-left text-sm font-semibold text-gray-900"
                          >
                            Действия
                          </th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-200 bg-white">
                        {loading && (
                          <tr>
                            <td colSpan={4} className="py-4 text-center text-sm text-gray-500">
                              Загрузка таблиц...
                            </td>
                          </tr>
                        )}
                        {!loading && filteredTables.length === 0 && (
                          <tr>
                            <td colSpan={4} className="py-4 text-center text-sm text-gray-500">
                              Нет доступных таблиц.
                            </td>
                          </tr>
                        )}
                        {!loading &&
                          filteredTables.map((table) => (
                            <tr key={table.table_name}>
                              <td className="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">
                                {table.display_name}
                              </td>
                              <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-700 capitalize">
                                {table.table_type === 'excel' ? 'Excel' : 'Google Таблицы'}
                              </td>
                              <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-700">
                                Подключен к дашбоарду
                              </td>
                              <td className="relative whitespace-nowrap py-4 pl-3 pr-4 text-sm font-medium sm:pr-6 flex gap-4">
                                <button
                                  onClick={() => handleUpdateTable(table.table_name)}
                                  className="text-blue-600 hover:underline"
                                >
                                  Обновить
                                </button>

                                <button
                                  onClick={() => handleDeleteTable(table.table_name)}
                                  className="text-red-600 hover:underline"
                                >
                                  Удалить
                                </button>

                                <button
                                  // onClick={() => handleEditTable(table)}
                                  className="text-gray-600 hover:underline"
                                >
                                  Редактировать
                                </button>
                              </td>
                            </tr>
                          ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            {/* Модальное окно для добавления отчета */}
            <Transition.Root show={isOpen} as={Fragment}>
              <Dialog as="div" className="fixed inset-0 z-50 overflow-y-auto" onClose={setIsOpen}>
                <div className="flex min-h-screen items-center justify-center p-4 text-center sm:p-0">
                  <Transition.Child
                    as={Fragment}
                    enter="ease-out duration-300"
                    enterFrom="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                    enterTo="opacity-100 translate-y-0 sm:scale-100"
                    leave="ease-in duration-200"
                    leaveFrom="opacity-100 translate-y-0 sm:scale-100"
                    leaveTo="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                  >
                    <Dialog.Panel className="relative transform overflow-hidden rounded-lg bg-white px-4 pt-5 pb-4 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6">
                      {/* Кнопка закрытия */}
                      <div className="absolute top-0 right-0 hidden pt-4 pr-4 sm:block">
                        <button
                          type="button"
                          className="rounded-md bg-white text-gray-400 hover:text-gray-500 focus:outline-none"
                          onClick={() => setIsOpen(false)}
                        >
                          <span className="sr-only">Закрыть</span>
                          <XMarkIcon className="h-6 w-6" aria-hidden="true" />
                        </button>
                      </div>

                      {/* Содержимое модального окна */}
                      <div className="sm:flex sm:items-start">
                        <div className="mt-3 text-center sm:mt-0 sm:text-left w-full">
                          <Dialog.Title
                            as="h3"
                            className="text-lg leading-6 font-medium text-gray-900"
                          >
                            Добавить Google таблицу
                          </Dialog.Title>
                          <div className="mt-2">
                            <form className="space-y-4">
                              <div>
                                <label htmlFor="reportName" className="block text-sm font-medium text-gray-700">
                                  Название отчета
                                </label>
                                <input
                                  type="text"
                                  name="reportName"
                                  id="reportName"
                                  value={reportName}
                                  onChange={(e) => setReportName(e.target.value)}
                                  className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                                  placeholder="Например, Отчет по продажам"
                                />
                              </div>
                              <div>
                                <label htmlFor="googleSheetURL" className="block text-sm font-medium text-gray-700">
                                  Ссылка на Google таблицу
                                </label>
                                <input
                                  type="url"
                                  name="googleSheetURL"
                                  id="googleSheetURL"
                                  value={googleSheetURL}
                                  onChange={(e) => setGoogleSheetURL(e.target.value)}
                                  className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                                  placeholder="https://docs.google.com/spreadsheets/..."
                                />
                              </div>
                              <div>
                                <label htmlFor="reportType" className="block text-sm font-medium text-gray-700">
                                  Тип отчета
                                </label>
                                <select
                                  id="reportType"
                                  name="reportType"
                                  value={reportType}
                                  onChange={(e) => setReportType(e.target.value)}
                                  className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                                >
                                  <option>Управленческий отчет</option>
                                  <option>Бухгалтерский отчет</option>
                                  <option>Иной отчет</option>
                                </select>
                              </div>
                            </form>
                          </div>
                        </div>
                      </div>
                      {/* Кнопки действия */}
                      <div className="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                        <button
                          type="button"
                          onClick={handleAddReport}
                          disabled={!googleSheetURL || !reportName}
                          className={classNames(
                            'inline-flex w-full justify-center rounded-md border border-transparent px-4 py-2 text-base font-medium shadow-sm focus:outline-none sm:ml-3 sm:w-auto sm:text-sm',
                            !googleSheetURL || !reportName
                              ? 'bg-gray-300 text-gray-700 cursor-not-allowed'
                              : 'bg-indigo-600 text-white hover:bg-indigo-700'
                          )}
                        >
                          Добавить
                        </button>
                        <button
                          type="button"
                          className="mt-3 inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                          onClick={() => setIsOpen(false)}
                        >
                          Отмена
                        </button>
                      </div>
                    </Dialog.Panel>
                  </Transition.Child>
                </div>
              </Dialog>
            </Transition.Root>

            {/* Модальное окно для редактирования колонок */}
            <Transition.Root show={isEditColumnsOpen} as={Fragment}>
              <Dialog as="div" className="fixed inset-0 z-50 overflow-y-auto" onClose={setIsEditColumnsOpen}>
                <div className="flex min-h-screen items-center justify-center p-4 text-center sm:p-0">
                  <Transition.Child
                    as={Fragment}
                    enter="ease-out duration-300"
                    enterFrom="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                    enterTo="opacity-100 translate-y-0 sm:scale-100"
                    leave="ease-in duration-200"
                    leaveFrom="opacity-100 translate-y-0 sm:scale-100"
                    leaveTo="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                  >
                    <Dialog.Panel className="relative transform overflow-hidden rounded-lg bg-white px-4 pt-5 pb-4 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl sm:p-6">
                      {/* Содержимое модального окна */}
                      <div>
                        <Dialog.Title as="h3" className="text-lg leading-6 font-medium text-gray-900">
                          Редактирование колонок таблицы
                        </Dialog.Title>
                        <div className="mt-4">
                          {schema && (
                            <form>
                              <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-300">
                                  <thead>
                                    <tr>
                                      <th className="px-3 py-2 text-left text-sm font-semibold text-gray-900">
                                        Название колонки
                                      </th>
                                      <th className="px-3 py-2 text-left text-sm font-semibold text-gray-900">
                                        Тип данных
                                      </th>
                                      <th className="px-3 py-2 text-left text-sm font-semibold text-gray-900">
                                        Описание
                                      </th>
                                    </tr>
                                  </thead>
                                  <tbody className="divide-y divide-gray-200">
                                    {schema.columns.map((column, index) => (
                                      <tr key={index}>
                                        <td className="px-3 py-2 text-sm text-gray-900">
                                          {column.column_name}
                                        </td>
                                        <td className="px-3 py-2 text-sm text-gray-900">
                                          {column.column_type}
                                        </td>
                                        <td className="px-3 py-2 text-sm text-gray-900">
                                          <input
                                            type="text"
                                            value={column.column_desc}
                                            onChange={(e) => {
                                              const updatedColumns = [...schema.columns]
                                              updatedColumns[index].column_desc = e.target.value
                                              setSchema({
                                                ...schema,
                                                columns: updatedColumns,
                                              })
                                            }}
                                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"
                                          />
                                        </td>
                                      </tr>
                                    ))}
                                  </tbody>
                                </table>
                              </div>
                            </form>
                          )}
                        </div>
                      </div>
                      {/* Кнопки действия */}
                      <div className="mt-5 sm:mt-6 sm:flex sm:flex-row-reverse">
                        <button
                          type="button"
                          onClick={handleCreateTable}
                          className="inline-flex w-full justify-center rounded-md border border-transparent px-4 py-2 bg-indigo-600 text-base font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm"
                        >
                          Подтвердить
                        </button>
                        <button
                          type="button"
                          className="mt-3 inline-flex w-full justify-center rounded-md border border-gray-300 px-4 py-2 bg-white text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                          onClick={() => setIsEditColumnsOpen(false)}
                        >
                          Отмена
                        </button>
                      </div>
                    </Dialog.Panel>
                  </Transition.Child>
                </div>
              </Dialog>
            </Transition.Root>
          </div>
        </main>
      </div>
    </div>
  )
}


File: ProtectedRoute.tsx
// app/hoc/ProtectedRoute.tsx
'use client'

import { useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { useAuth } from '../context/AuthContext' // Убедитесь, что путь к AuthContext правильный

interface ProtectedRouteProps {
  children: React.ReactNode
}

const ProtectedRoute = ({ children }: ProtectedRouteProps) => {
  const { token } = useAuth()
  const router = useRouter()

  useEffect(() => {
    if (!token) {
      router.push('/signin')
    }
  }, [token, router])

  if (!token) {
    return null // Или можно добавить индикатор загрузки
  }

  return <>{children}</>
}

export default ProtectedRoute


File: actions.ts
'use server'
import { signIn } from "@/auth";

async function sleep (ms: number) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

export async function createTodo(prevState: any, formData: FormData) {  
  try {
    await sleep(2000)
    return { message: 'Created' }
  } catch (e) {
    return { message: 'Failed to create' }
  }
}

export async function authorization (formData: FormData) {  
  await signIn('credentials', formData)
}

export async function googleAuthorization () {  
  await signIn('google')
}

File: prisma.ts
import { PrismaClient } from "@prisma/client"

const prisma = new PrismaClient({
  log: [
    // {
    //   emit: 'stdout',
    //   level: 'query'
    // },
    {
      emit: 'stdout',
      level: 'error'
    },
    {
      emit: 'stdout',
      level: 'info'
    },
    {
      emit: 'stdout',
      level: 'warn'
    }
  ]
})


export default prisma

File: page.tsx
// app/signin/page.tsx
'use client'

import { useState, FormEvent } from 'react'
import Link from 'next/link'
import { useAuth } from '../context/AuthContext'
import { API_BASE_URL } from 'baseapi/config' // Используем новый алиас

export default function SigninPage() {
  const [email, setEmail] = useState<string>('')
  const [password, setPassword] = useState<string>('')
  const [message, setMessage] = useState<string>('') 
  const { login } = useAuth() 
  const [isLoading, setIsLoading] = useState<boolean>(false)

  const handleLogin = async (event: FormEvent<HTMLFormElement>) => {
    event.preventDefault()
    setMessage('')
    setIsLoading(true)

    try {
      const response = await fetch(`${API_BASE_URL}/login`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email, password })
      })

      const result = await response.json()

      if (response.ok && result.token) {
        await login(result.token) // Вызов функции логина из AuthContext с передачей токена
      } else {
        setMessage(result.message || 'Ошибка при входе.')
      }
    } catch (error) {
      console.error('Ошибка входа:', error)
      setMessage('Произошла ошибка. Пожалуйста, попробуйте позже.')
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <div className="flex min-h-full flex-1 flex-col justify-center py-12 sm:px-6 lg:px-8">
      <div className="mt-10 sm:mx-auto sm:w-full sm:max-w-md">
        <div className="bg-white px-6 py-12 shadow sm:rounded-lg sm:px-12">
          <div>
            <h2 className="text-2xl font-bold leading-9 tracking-tight text-gray-900">Вход в Панельку</h2>
            <p className="mt-2 text-sm text-gray-600">Полноценный доступ к работе с сервисом</p>
          </div>

          {/* Отображение сообщений */}
          {message && (
            <div className="mt-4 text-center text-sm text-red-600">
              {message}
            </div>
          )}

          <form onSubmit={handleLogin} className="mt-8 space-y-6">
            <div>
              <label htmlFor="email" className="sr-only">Email</label>
              <input
                id="email"
                name="email"
                type="email"
                placeholder="Ваш email"
                required
                autoComplete="email"
                className="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-indigo-600 sm:text-sm"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
              />
            </div>

            <div>
              <label htmlFor="password" className="sr-only">Пароль</label>
              <input
                id="password"
                name="password"
                type="password"
                placeholder="Ваш пароль"
                required
                autoComplete="current-password"
                className="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-indigo-600 sm:text-sm"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
              />
            </div>

            <div className="flex items-center justify-between">
              <div className="flex items-center">
                <input
                  id="remember-me"
                  name="remember-me"
                  type="checkbox"
                  className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600"
                />
                <label htmlFor="remember-me" className="ml-2 block text-sm text-gray-900">
                  Запомнить меня
                </label>
              </div>

              <div className="text-sm">
                <a href="#" className="font-medium text-indigo-600 hover:text-indigo-500">
                  Забыли пароль?
                </a>
              </div>
            </div>

            <div>
              <button
                type="submit"
                disabled={isLoading}
                className={`flex w-full justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2 ${isLoading ? 'opacity-50 cursor-not-allowed' : ''}`}
              >
                {isLoading ? 'Вход...' : 'Войти'}
              </button>
            </div>
          </form>

          <div className="mt-6">
            <div className="relative">
              <div className="absolute inset-0 flex items-center">
                <div className="w-full border-t border-gray-300" />
              </div>
              <div className="relative flex justify-center text-sm">
                <span className="bg-white px-2 text-gray-500">Или войти через</span>
              </div>
            </div>

            <div className="mt-6 grid grid-cols-1 gap-4">
              {/* Реализуйте кнопки для социальных логинов, если необходимо */}
            </div>
          </div>
        </div>

        <p className="mt-10 text-center text-sm text-gray-500">
          Еще не зарегистрированы?{' '}
          <Link href="/signup" className="font-medium text-indigo-600 hover:text-indigo-500">
            Пройти регистрацию
          </Link>
        </p>
      </div>
    </div>
  )
}


File: page.tsx
// app/signup/page.tsx
'use client'

import { useState, FormEvent } from 'react'
import Link from 'next/link'
import { useRouter } from 'next/navigation'
import { API_BASE_URL } from 'baseapi/config' // Используем новый алиас

export default function SignupPage() {
  const [username, setUsername] = useState('')
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('') // Добавляем поле для пароля
  const [message, setMessage] = useState('')
  const [isLoading, setIsLoading] = useState(false)
  const router = useRouter()

  const register = async (e: FormEvent<HTMLFormElement>) => {
    e.preventDefault()
    setIsLoading(true)
    setMessage('')

    try {
      const response = await fetch(`${API_BASE_URL}/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, username, password }) // Передаем пароль
      })

      const data = await response.json()

      if (response.ok) {
        setMessage('Регистрация прошла успешно!')
        router.push('/signin')
      } else {
        setMessage(data.message || 'Ошибка при регистрации.')
      }
    } catch (error) {
      console.error('Ошибка регистрации:', error)
      setMessage('Произошла ошибка. Пожалуйста, попробуйте позже.')
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <div className="flex min-h-full flex-1 flex-col justify-center py-12 sm:px-6 lg:px-8">
      <div className="mt-10 sm:mx-auto sm:w-full sm:max-w-md">
        <div className="bg-white px-6 py-12 shadow sm:rounded-lg sm:px-12">
          <div>
            <h2 className="text-2xl font-bold leading-9 tracking-tight text-gray-900">Регистрация в Панельку</h2>
            <p className="mt-2 text-sm text-gray-600">Полноценный доступ к работе с сервисом</p>
          </div>

          {/* Отображение сообщений */}
          {message && (
            <div className={`mt-4 text-center text-sm ${message.includes('успешно') ? 'text-green-600' : 'text-red-600'}`}>
              {message}
            </div>
          )}

          <form onSubmit={register} className="mt-8 space-y-6">
            <div>
              <label htmlFor="username" className="sr-only">Как вас зовут?</label>
              <input
                id="username"
                name="username"
                type="text"
                placeholder="Как вас зовут?"
                required
                className="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-indigo-600 sm:text-sm"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
              />
            </div>

            <div>
              <label htmlFor="email" className="sr-only">Email</label>
              <input
                id="email"
                name="email"
                type="email"
                placeholder="Email"
                required
                className="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-indigo-600 sm:text-sm"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
              />
            </div>

            <div>
              <label htmlFor="password" className="sr-only">Пароль</label>
              <input
                id="password"
                name="password"
                type="password"
                placeholder="Пароль"
                required
                className="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-indigo-600 sm:text-sm"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
              />
            </div>

            <div className="flex items-center justify-between">
              <div className="flex items-center">
                <input
                  id="remember-me"
                  name="remember-me"
                  type="checkbox"
                  className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600"
                />
                <label htmlFor="remember-me" className="ml-2 block text-sm text-gray-900">
                  Запомнить меня
                </label>
              </div>

              <div className="text-sm">
                <a href="#" className="font-medium text-indigo-600 hover:text-indigo-500">
                  Забыли пароль?
                </a>
              </div>
            </div>

            <div>
              <button
                type="submit"
                disabled={isLoading}
                className={`flex w-full justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2 ${isLoading ? 'opacity-50 cursor-not-allowed' : ''}`}
              >
                {isLoading ? 'Регистрация...' : 'Зарегистрироваться'}
              </button>
            </div>
          </form>

          <div className="mt-6">
            <div className="relative">
              <div className="absolute inset-0 flex items-center">
                <div className="w-full border-t border-gray-300" />
              </div>
              <div className="relative flex justify-center text-sm">
                <span className="bg-white px-2 text-gray-500">Или войти через</span>
              </div>
            </div>

            <div className="mt-6 grid grid-cols-1 gap-4">
              {/* Реализуйте кнопки для социальных логинов, если необходимо */}
            </div>
          </div>
        </div>

        <p className="mt-10 text-center text-sm text-gray-500">
          Уже зарегистрированы?{' '}
          <Link href="/signin" className="font-medium text-indigo-600 hover:text-indigo-500">
            Войти в аккаунт
          </Link>
        </p>
      </div>
    </div>
  )
}


File: page.tsx
// import { auth, signIn, signOut } from "../../auth";

function SignIn() {
//   return (
//     <form
//       action={async () => {
//         "use server";
//         await signIn("github");
//       }}
//     >
//       <p>You are not logged in</p>
//       <button type="submit">Sign in with GitHub</button>
//     </form>
//   );
// }

// function SignOut({ children }: { children: React.ReactNode }) {
//   return (
//     <form
//       action={async () => {
//         "use server";
//         await signOut();
//       }}
//     >
//       <p>{children}</p>
//       <button type="submit">Sign out</button>
//     </form>
//   );
// }

// export default async function Page() {
//   let session = await auth();
//   let user = session?.user?.email;

//   return (
//     <section>
//       <h1>Home</h1>
//       <div>{user ? <SignOut>{`Welcome ${user}`}</SignOut> : <SignIn />}</div>
//     </section>
  // );
}

